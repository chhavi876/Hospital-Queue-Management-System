<!DOCTYPE html>
<html>
<head>
    <title>Patient Dashboard</title>
    <style>
        .dashboard-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .queue-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .refresh-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Welcome, {{ patient.name }}!</h1>
        
        <div class="queue-info">
            <h2>Your Queue Information</h2>
            <p><strong>Queue ID:</strong> <span id="queue-id">{{ queue_entry.queue_id }}</span></p>
            <p><strong>Service:</strong> <span id="service-name">{{ queue_entry.service.service_name }}</span></p>
            <p><strong>Counter:</strong> 
                <span id="counter-name">
                    {% if queue_entry.counter %}
                        {{ queue_entry.counter.counter_name }}
                    {% else %}
                        Not assigned yet
                    {% endif %}
                </span>
            </p>
            <p><strong>Status:</strong> <span id="queue-status">{{ queue_entry.get_current_status_display }}</span></p>
        </div>
    </div>

    <div class="refresh-indicator" id="refresh-indicator">
        Last updated: <span id="last-updated">Just now</span>
    </div>

    <script>
        // Auto-refresh every 5 seconds as fallback
        function updateDashboard() {
            fetch('/patient/get_queue_status/')
                .then(response => response.json())
                .then(data => {
                    if (data.queue_status) {
                        document.getElementById('queue-status').textContent = 
                            data.queue_status.charAt(0).toUpperCase() + data.queue_status.slice(1);
                        
                        if (data.queue_status === 'serving') {
                            document.getElementById('queue-status').textContent = 'Currently Being Served';
                        } else if (data.queue_status === 'completed') {
                            window.location.href = '/queue/completed/';
                        }
                    }
                    
                    // Update last updated time
                    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                });
        }

        // WebSocket connection for real-time updates
        const socket = new WebSocket(
            'ws://' + window.location.host + '/ws/queue/updates/'
        );
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.queue_id === '{{ queue_entry.queue_id }}') {
                updateDashboard(); // Refresh data when WS message received
            }
        };

        // Initial load and set interval
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>